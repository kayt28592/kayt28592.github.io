<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flowrite - Form Builder</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Flowrite">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flowrite">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    
    <!-- Favicon & Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Archivo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script>
        // ============================================
        // üî• FIREBASE CONFIG - FLOWRITE
        // ============================================
        // NOTE: Firebase API keys are safe to expose in client-side code
        // Security is handled by Firebase Security Rules, not by hiding the API key
        // See: https://firebase.google.com/docs/projects/api-keys
        const firebaseConfig = {
            apiKey: "AIzaSyAWGjZDUuFGW-0499LRko2DLxXCbzXfGzQ",
            authDomain: "flowrite-3191a.firebaseapp.com",
            projectId: "flowrite-3191a",
            storageBucket: "flowrite-3191a.firebasestorage.app",
            messagingSenderId: "1020192916211",
            appId: "1:1020192916211:web:18a70188b749a1dec5ad86",
            measurementId: "G-J83WXPEFJ3"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        console.log('üî• Firebase initialized with Authentication!');
    </script>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --light: #f4f4f9;
            --gray: #6c757d;
            --border: #dee2e6;
            --success: #28a745;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Login Screen Styles */
        .login-wrapper {
            display: flex !important;
            align-items: center;
            justify-content: center;
            min-height: 600px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 450px;
            animation: slideUp 0.6s ease-out;
        }

        .login-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 2.5rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .login-content {
            padding: 2.5rem;
        }

        .login-content h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .login-info {
            background: #f8f9fa;
            border-left: 4px solid var(--accent);
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .login-info p {
            margin: 0.5rem 0;
            color: var(--gray);
        }

        .login-info code {
            background: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: var(--accent);
            font-weight: 600;
        }

        /* Main App Styles */
        .app-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 2rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .header-left {
            text-align: left;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            font-weight: 600;
        }

        .logout-button {
            padding: 0.6rem 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5rem;
            color: white;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .tagline {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: 300;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 1.2rem;
            background: none;
            border: none;
            font-family: 'Archivo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab.active {
            color: var(--accent);
        }

        .tab.active::after {
            transform: scaleX(1);
        }

        .tab:hover {
            background: rgba(233, 69, 96, 0.05);
        }

        .tab-content {
            display: none;
            padding: 2.5rem;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-grid {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        label {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .required {
            color: var(--accent);
            margin-left: 3px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            padding: 0.9rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Archivo', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 0.5rem;
            align-items: end;
        }

        .time-period {
            display: flex;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .time-period button {
            flex: 1;
            padding: 0.9rem 1rem;
            border: none;
            background: white;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-period button.active {
            background: var(--accent);
            color: white;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .upload-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.5rem;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .signature-pad {
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .signature-controls button {
            padding: 0.6rem 1.2rem;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .signature-controls button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .submit-button {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, var(--accent) 0%, #d63447 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Archivo', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 2rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.4);
        }

        .submit-button:active {
            transform: translateY(-1px);
        }

        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .preview-image {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border);
            background: #f8f9fa;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .preview-image button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            background: rgba(233, 69, 96, 0.95);
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .preview-image button:hover {
            background: var(--accent);
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .preview-image button:active {
            transform: scale(1.1);
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }

        .field-item {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .field-item:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .field-info h4 {
            color: var(--primary);
            margin-bottom: 0.3rem;
        }

        .field-info p {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .field-actions {
            display: flex;
            gap: 0.5rem;
        }

        .field-actions button {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .field-actions button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Submission Modal Styles */
        .submission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-box {
            position: relative;
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 2rem;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row strong {
            color: var(--primary);
            font-weight: 600;
        }

        .detail-row span {
            color: var(--gray);
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-edit, .btn-close {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-close {
            background: var(--border);
            color: var(--gray);
        }

        .btn-close:hover {
            background: var(--gray);
            color: white;
        }

        /* Camera Modal Styles */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.95);
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-container {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
        }

        .camera-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .camera-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .camera-view {
            position: relative;
            background: #000;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            max-height: calc(90vh - 160px);
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-height: 100%;
        }

        #cameraCanvas {
            display: none;
        }

        .camera-controls {
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            background: white;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .camera-btn-capture {
            background: linear-gradient(135deg, var(--accent) 0%, #d63447 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .camera-btn-capture:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
        }

        .camera-btn-cancel {
            background: var(--border);
            color: var(--gray);
        }

        .camera-btn-cancel:hover {
            background: var(--gray);
            color: white;
        }

        @media (max-width: 768px) {
            .camera-container {
                max-width: 95vw;
                max-height: 95vh;
            }

            .camera-view {
                max-height: calc(95vh - 160px);
            }

            .camera-controls {
                padding: 1rem;
                flex-direction: column;
            }

            .camera-btn {
                width: 100%;
                padding: 0.8rem 1.5rem;
            }

            .camera-header h3 {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .logo {
                font-size: 2.5rem;
            }

            .tab {
                font-size: 0.85rem;
                padding: 1rem 0.5rem;
            }

            .tab-content {
                padding: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-left {
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-box {
                margin: 1rem;
            }

            .detail-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .modal-footer {
                flex-direction: column;
            }

            .btn-edit, .btn-close {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-wrapper" id="loginScreen">
            <div class="login-box">
                <div class="login-header">
                    <h1 class="logo">Flowrite</h1>
                    <p class="tagline">Concrete Recycling & Materials</p>
                </div>
                <div class="login-content">
                    <!-- Login/Register Tabs -->
                    <div style="display: flex; margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; border: 2px solid var(--border);">
                        <button type="button" id="loginTabBtn" class="auth-tab-btn active" onclick="showAuthTab('login')" style="flex: 1; padding: 0.8rem; border: none; background: var(--accent); color: white; font-family: 'Archivo', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.3s;">Login</button>
                        <button type="button" id="registerTabBtn" class="auth-tab-btn" onclick="showAuthTab('register')" style="flex: 1; padding: 0.8rem; border: none; background: white; color: var(--gray); font-family: 'Archivo', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.3s;">Register</button>
                    </div>

                    <!-- Login Form -->
                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required placeholder="Enter your password">
                        </div>
                        <div id="loginError" style="display: none; padding: 1rem; background: #fee; border-left: 4px solid #dc3545; border-radius: 4px; margin: 1rem 0; color: #dc3545; font-size: 0.9rem;">
                            <strong>‚ö†Ô∏è Login Failed:</strong> <span id="loginErrorMsg">Invalid email or password.</span>
                        </div>
                        <button type="submit" class="submit-button">üîê Login</button>
                        <p style="text-align: center; margin-top: 1rem; font-size: 0.85rem; color: var(--gray);">
                            <a href="#" onclick="resetPassword(); return false;" style="color: var(--accent);">Forgot Password?</a>
                        </p>
                    </form>

                    <!-- Register Form -->
                    <form id="registerForm" style="display: none;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="registerName" required placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="registerPassword" required placeholder="Min 6 characters" minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="registerConfirmPassword" required placeholder="Confirm your password">
                        </div>
                        <div id="registerError" style="display: none; padding: 1rem; background: #fee; border-left: 4px solid #dc3545; border-radius: 4px; margin: 1rem 0; color: #dc3545; font-size: 0.9rem;">
                            <strong>‚ö†Ô∏è Error:</strong> <span id="registerErrorMsg"></span>
                        </div>
                        <div id="registerSuccess" style="display: none; padding: 1rem; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px; margin: 1rem 0; color: #155724; font-size: 0.9rem;">
                            <strong>‚úÖ Success!</strong> Account created. You can now login.
                        </div>
                        <button type="submit" class="submit-button" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">üìù Create Account</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div class="app-wrapper" id="mainApp" style="display: none;">
            <div class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h1 class="logo">Flowrite</h1>
                        <p class="tagline">Concrete Recycling & Materials</p>
                    </div>
                    <div class="header-right">
                        <div class="user-info">
                            <span id="userRole"></span>
                            <button class="logout-button" id="logoutButton">Logout</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="form">Fill Form</button>
                <button class="tab" data-tab="submissions" id="submissionsTab" style="display: none;">Submissions</button>
                <button class="tab" data-tab="customers" id="customersTab" style="display: none;">Customers</button>
                <button class="tab" data-tab="items" id="itemsTab" style="display: none;">Items</button>
            </div>

            <!-- Fill Form Tab -->
            <div class="tab-content active" id="form">
                <form id="mainForm">
                    <div class="form-grid">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date <span class="required">*</span></label>
                                <input type="date" id="formDate" required>
                            </div>
                            <div class="form-group">
                                <label>Hour/Minutes</label>
                                <div class="time-inputs">
                                    <input type="number" id="hour" min="1" max="12" placeholder="HH">
                                    <input type="number" id="minute" min="0" max="59" placeholder="MM">
                                    <div class="time-period">
                                        <button type="button" class="time-btn" data-period="AM">AM</button>
                                        <button type="button" class="time-btn" data-period="PM">PM</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Customer <span class="required">*</span></label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" id="customer" required list="customerList" placeholder="Type to search or select a customer" style="flex: 1;" autocomplete="off">
                                <datalist id="customerList"></datalist>
                                <button type="button" class="upload-button" id="createCustomerFromForm" style="margin: 0; white-space: nowrap;">
                                    <span>‚ûï</span> Create New
                                </button>
                            </div>
                            <div id="customerInfo" style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; display: none; font-size: 0.85rem;">
                                <div><strong>Email:</strong> <span id="customerInfoEmail"></span></div>
                                <div><strong>Phone:</strong> <span id="customerInfoPhone"></span></div>
                                <div><strong>Address:</strong> <span id="customerInfoAddress"></span></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Address <span class="required">*</span></label>
                            <input type="text" id="address" required placeholder="Street Address">
                            <p class="help-text">Street Address</p>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Order <span class="required">*</span></label>
                                <input type="text" id="order" required list="orderList" placeholder="Type to search or select item" autocomplete="off">
                                <datalist id="orderList">
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label>Amount <span class="required">*</span></label>
                                <input type="number" id="amount" required placeholder="e.g. 3.3" step="0.1">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Rego <span class="required">*</span></label>
                            <input type="text" id="rego" required placeholder="Enter registration">
                        </div>

                        <div class="form-group">
                            <label>Attach Ticket</label>
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-icon">üì∏</div>
                                <p class="upload-text">Drag & drop images here</p>
                                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; flex-wrap: wrap;">
                                    <button type="button" class="upload-button" id="uploadButton">
                                        <span>üìÅ</span> Choose File
                                    </button>
                                    <button type="button" class="upload-button" id="cameraButton" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                        <span>üì∑</span> Take Photo
                                    </button>
                                </div>
                                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                            </div>
                            <div class="preview-images" id="previewImages"></div>
                        </div>

                        <div class="form-group">
                            <label>Signature <span class="required">*</span></label>
                            <canvas class="signature-pad" id="signaturePad" width="800" height="200"></canvas>
                            <div class="signature-controls">
                                <button type="button" id="clearSignature">Clear</button>
                                <button type="button" id="undoSignature">Undo</button>
                            </div>
                        </div>

                        <button type="submit" class="submit-button">Submit</button>
                    </div>
                </form>
            </div>

            <!-- Submissions Tab -->
            <div class="tab-content" id="submissions">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin: 0;">Form Submissions</h3>
                    <button class="submit-button" id="createDocketBtn" style="width: auto; margin: 0; padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <span>üìÑ</span> Create Docket
                    </button>
                </div>
                <div id="submissionsList">
                    <p style="text-align: center; color: var(--gray); padding: 2rem;">No submissions yet. Fill out the form to see submissions here.</p>
                </div>
            </div>

            <!-- Customers Tab -->
            <div class="tab-content" id="customers">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin: 0;">Customer Management</h3>
                    <button class="submit-button" id="addCustomerBtn" style="width: auto; margin: 0; padding: 0.8rem 1.5rem;">
                        <span>‚ûï</span> Add New Customer
                    </button>
                </div>
                <div id="customersList">
                    <p style="text-align: center; color: var(--gray); padding: 2rem;">No customers yet. Click "Add New Customer" to get started.</p>
                </div>
            </div>

            <!-- Items Tab -->
            <div class="tab-content" id="items">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin: 0;">Item Management</h3>
                    <button class="submit-button" id="addItemBtn" style="width: auto; margin: 0; padding: 0.8rem 1.5rem;">
                        <span>‚ûï</span> Add New Item
                    </button>
                </div>
                <div id="itemsList">
                    <p style="text-align: center; color: var(--gray); padding: 2rem;">No items yet. Click "Add New Item" to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <div class="camera-header">
                <h3>üì∑ Take Photo</h3>
                <button class="close-btn" id="closeCameraModal">√ó</button>
            </div>
            <div class="camera-view">
                <video id="cameraVideo" autoplay playsinline></video>
                <canvas id="cameraCanvas"></canvas>
            </div>
            <div class="camera-controls">
                <button class="camera-btn camera-btn-capture" id="capturePhoto">
                    <span>üì∏</span> Capture Photo
                </button>
                <button class="camera-btn camera-btn-cancel" id="cancelCamera">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="submission-modal" id="customerModal" style="display: none;">
        <div class="modal-overlay" onclick="closeCustomerModal()"></div>
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="customerModalTitle">Add New Customer</h3>
                <button class="close-btn" onclick="closeCustomerModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="form-group">
                        <label>Customer Name <span class="required">*</span></label>
                        <input type="text" id="customerName" required placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" id="customerEmail" required placeholder="customer@example.com">
                    </div>
                    <div class="form-group">
                        <label>Phone <span class="required">*</span></label>
                        <input type="text" id="customerPhone" required placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Address <span class="required">*</span></label>
                        <textarea id="customerAddress" required placeholder="Enter full address" rows="3" style="resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-edit" onclick="saveCustomer()">Save Customer</button>
                <button class="btn-close" onclick="closeCustomerModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Item Modal -->
    <div class="submission-modal" id="itemModal" style="display: none;">
        <div class="modal-overlay" onclick="closeItemModal()"></div>
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="itemModalTitle">Add New Item</h3>
                <button class="close-btn" onclick="closeItemModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="form-group">
                        <label>Item Name <span class="required">*</span></label>
                        <input type="text" id="itemName" required placeholder="Enter item name">
                    </div>
                    <div class="form-group">
                        <label>Price <span class="required">*</span></label>
                        <input type="number" id="itemPrice" required placeholder="0.00" step="0.01" min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-edit" onclick="saveItem()">Save Item</button>
                <button class="btn-close" onclick="closeItemModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Docket Modal -->
    <div class="submission-modal" id="docketModal" style="display: none;">
        <div class="modal-overlay" onclick="closeDocketModal()"></div>
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üìÑ Create Docket</h3>
                <button class="close-btn" onclick="closeDocketModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="docketForm">
                    <div class="form-group">
                        <label>Customer <span class="required">*</span></label>
                        <select id="docketCustomer" required style="width: 100%;">
                            <option value="">Select a customer</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date <span class="required">*</span></label>
                            <input type="date" id="docketStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date <span class="required">*</span></label>
                            <input type="date" id="docketEndDate" required>
                        </div>
                    </div>
                    <div id="docketPreview" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; display: none;">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Preview:</h4>
                        <p id="docketPreviewText" style="color: var(--gray);"></p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-edit" onclick="previewDocket()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Preview</button>
                <button class="btn-edit" onclick="generateDocket()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">Create Docket</button>
                <button class="btn-close" onclick="closeDocketModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Docket View Modal -->
    <div class="submission-modal" id="docketViewModal" style="display: none;">
        <div class="modal-overlay" onclick="closeDocketViewModal()"></div>
        <div class="modal-box" style="max-width: 210mm; width: 210mm; max-height: 95vh; border-radius: 20px; overflow: hidden;">
            <div class="modal-header" style="padding: 1.5rem 2rem;">
                <h3>üìÑ Docket View</h3>
                <button class="close-btn" onclick="closeDocketViewModal()">√ó</button>
            </div>
            <div class="modal-body" id="docketViewContent" style="max-height: calc(95vh - 200px); overflow-y: auto; padding: 0; background: white;">
                <!-- Docket content will be inserted here -->
            </div>
            <div class="modal-footer" style="padding: 1.5rem 2rem;">
                <button class="btn-edit" onclick="printDocket()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üñ®Ô∏è Print</button>
                <button class="btn-close" onclick="closeDocketViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // üîê FIREBASE AUTHENTICATION SYSTEM
        // ============================================
        
        // Auth Tab Switching
        function showAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTabBtn = document.getElementById('loginTabBtn');
            const registerTabBtn = document.getElementById('registerTabBtn');
            
            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTabBtn.style.background = 'var(--accent)';
                loginTabBtn.style.color = 'white';
                registerTabBtn.style.background = 'white';
                registerTabBtn.style.color = 'var(--gray)';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                registerTabBtn.style.background = 'var(--accent)';
                registerTabBtn.style.color = 'white';
                loginTabBtn.style.background = 'white';
                loginTabBtn.style.color = 'var(--gray)';
            }
            
            // Clear errors
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('registerSuccess').style.display = 'none';
        }
        
        // Reset Password
        function resetPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                alert('Please enter your email address first.');
                return;
            }
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert('Password reset email sent! Check your inbox.');
                })
                .catch((error) => {
                    alert('Error: ' + error.message);
                });
        }
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Firebase Auth...');
            
            // User Authentication System
            let currentUser = null;

            // Get elements
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const userRoleDisplay = document.getElementById('userRole');
            const logoutButton = document.getElementById('logoutButton');
            const submissionsTab = document.getElementById('submissionsTab');
            const loginError = document.getElementById('loginError');

            // Hide error message when user starts typing
            document.getElementById('loginEmail').addEventListener('input', function() {
                if (loginError) loginError.style.display = 'none';
            });
            document.getElementById('loginPassword').addEventListener('input', function() {
                if (loginError) loginError.style.display = 'none';
            });

            console.log('Elements found:', {
                loginForm: !!loginForm,
                loginScreen: !!loginScreen,
                mainApp: !!mainApp
            });

            // ============================================
            // üîë FIREBASE AUTH STATE LISTENER
            // ============================================
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('üîì User logged in:', user.email);
                    
                    // Get user role from Firestore
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        const userData = userDoc.exists ? userDoc.data() : { role: 'customer', name: user.email };
                        
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            username: userData.name || user.email.split('@')[0],
                            role: userData.role || 'customer'
                        };
                        
                        showMainApp(currentUser);
                    } catch (error) {
                        console.error('Error getting user data:', error);
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            username: user.email.split('@')[0],
                            role: 'customer'
                        };
                        showMainApp(currentUser);
                    }
                } else {
                    console.log('üîí User logged out');
                    currentUser = null;
                    showLoginScreen();
                }
            });
            
            // Show Main App
            function showMainApp(user) {
                loginScreen.style.display = 'none';
                loginScreen.style.visibility = 'hidden';
                loginScreen.style.position = 'absolute';
                loginScreen.style.left = '-9999px';
                
                mainApp.style.display = 'block';
                mainApp.style.visibility = 'visible';
                mainApp.style.position = 'relative';
                mainApp.style.opacity = '1';
                
                // Update UI based on role
                if (user.role === 'admin') {
                    userRoleDisplay.textContent = 'üë§ ' + user.username + ' (Admin)';
                    submissionsTab.style.display = 'block';
                    document.getElementById('customersTab').style.display = 'block';
                    document.getElementById('itemsTab').style.display = 'block';
                    console.log('Admin logged in - showing all tabs');
                } else {
                    userRoleDisplay.textContent = 'üë§ ' + user.username;
                    submissionsTab.style.display = 'none';
                    document.getElementById('customersTab').style.display = 'none';
                    document.getElementById('itemsTab').style.display = 'none';
                    console.log('Customer logged in - hiding admin tabs');
                }
                
                // Ensure we're on the form tab
                document.querySelector('[data-tab="form"]').click();
                
                // Set today's date and current time
                const now = new Date();
                const todayDate = now.toISOString().split('T')[0];
                document.getElementById('formDate').value = todayDate;
                
                // Set current time
                let hours = now.getHours();
                const minutes = now.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                
                document.getElementById('hour').value = hours;
                document.getElementById('minute').value = minutes.toString().padStart(2, '0');
                
                document.querySelectorAll('.time-btn').forEach(btn => {
                    if (btn.dataset.period === ampm) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Populate customer dropdown
                populateCustomerDropdown();
                
                console.log('‚úÖ Main app loaded for:', user.email);
            }
            
            // Show Login Screen
            function showLoginScreen() {
                loginScreen.style.display = 'flex';
                loginScreen.style.visibility = 'visible';
                loginScreen.style.position = 'relative';
                loginScreen.style.left = '0';
                
                mainApp.style.display = 'none';
                mainApp.style.visibility = 'hidden';
            }

            // ============================================
            // üìù LOGIN FORM HANDLER
            // ============================================
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Login form submitted!');
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                
                // Show loading state
                const submitBtn = loginForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Logging in...';
                submitBtn.disabled = true;

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    console.log('‚úÖ Login successful!');
                    loginForm.reset();
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    document.getElementById('loginErrorMsg').textContent = getAuthErrorMessage(error.code);
                    document.getElementById('loginError').style.display = 'block';
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
            
            // ============================================
            // üìù REGISTER FORM HANDLER
            // ============================================
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Register form submitted!');
                
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                
                // All new registrations are customers only
                // Admin account must be created manually in Firebase Console
                const role = 'customer';
                
                // Validate passwords match
                if (password !== confirmPassword) {
                    document.getElementById('registerErrorMsg').textContent = 'Passwords do not match!';
                    document.getElementById('registerError').style.display = 'block';
                    return;
                }
                
                // Show loading state
                const submitBtn = registerForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Creating account...';
                submitBtn.disabled = true;
                
                try {
                    // Create user in Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Save user data to Firestore (always as customer)
                    await db.collection('users').doc(user.uid).set({
                        name: name,
                        email: email,
                        role: role,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('‚úÖ User registered as customer:', user.uid);
                    
                    // Show success and switch to login
                    document.getElementById('registerSuccess').style.display = 'block';
                    document.getElementById('registerError').style.display = 'none';
                    registerForm.reset();
                    
                    // Auto switch to login after 2 seconds
                    setTimeout(() => {
                        showAuthTab('login');
                        document.getElementById('loginEmail').value = email;
                    }, 2000);
                    
                } catch (error) {
                    console.error('‚ùå Register error:', error);
                    document.getElementById('registerErrorMsg').textContent = getAuthErrorMessage(error.code);
                    document.getElementById('registerError').style.display = 'block';
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // ============================================
            // üö™ LOGOUT HANDLER
            // ============================================
            logoutButton.addEventListener('click', async () => {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        await auth.signOut();
                        console.log('‚úÖ Logged out successfully');
                        document.querySelector('[data-tab="form"]').click();
                    } catch (error) {
                        console.error('‚ùå Logout error:', error);
                        alert('Error logging out: ' + error.message);
                    }
                }
            });
            
            // ============================================
            // üîß HELPER FUNCTIONS
            // ============================================
            function getAuthErrorMessage(errorCode) {
                const errorMessages = {
                    'auth/invalid-email': 'Invalid email address.',
                    'auth/user-disabled': 'This account has been disabled.',
                    'auth/user-not-found': 'No account found with this email.',
                    'auth/wrong-password': 'Incorrect password.',
                    'auth/invalid-credential': 'Invalid email or password.',
                    'auth/email-already-in-use': 'Email already registered.',
                    'auth/weak-password': 'Password must be at least 6 characters.',
                    'auth/too-many-requests': 'Too many attempts. Please try again later.'
                };
                return errorMessages[errorCode] || 'An error occurred. Please try again.';
            }

        // Tab Switching
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Time Period Toggle
        const timeBtns = document.querySelectorAll('.time-btn');
        timeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                timeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // File Upload
        const uploadArea = document.getElementById('uploadArea');
        const uploadButton = document.getElementById('uploadButton');
        const cameraButton = document.getElementById('cameraButton');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const previewImages = document.getElementById('previewImages');
        window.uploadedFiles = []; // Make globally accessible

        uploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        cameraButton.addEventListener('click', () => {
            // Try to use advanced camera modal first
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                openCameraModal();
            } else {
                // Fallback to file input with camera capture
                cameraInput.click();
            }
        });

        // Camera Modal Functionality
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const capturePhotoBtn = document.getElementById('capturePhoto');
        const cancelCameraBtn = document.getElementById('cancelCamera');
        const closeCameraModalBtn = document.getElementById('closeCameraModal');
        let cameraStream = null;

        async function openCameraModal() {
            try {
                cameraModal.classList.add('active');
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                cameraVideo.srcObject = cameraStream;
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please allow camera permissions or use the "Choose File" option.');
                cameraModal.classList.remove('active');
                // Fallback to file input
                cameraInput.click();
            }
        }

        function closeCameraModal() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraVideo.srcObject = null;
            cameraModal.classList.remove('active');
        }

        capturePhotoBtn.addEventListener('click', () => {
            // Set canvas size to match video
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            
            // Draw video frame to canvas
            const ctx = cameraCanvas.getContext('2d');
            ctx.drawImage(cameraVideo, 0, 0);
            
            // Convert canvas to blob
            cameraCanvas.toBlob((blob) => {
                const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                handleFiles([file]);
                closeCameraModal();
            }, 'image/jpeg', 0.95);
        });

        cancelCameraBtn.addEventListener('click', closeCameraModal);
        closeCameraModalBtn.addEventListener('click', closeCameraModal);


        uploadArea.addEventListener('click', (e) => {
            if (e.target === uploadArea || e.target.classList.contains('upload-icon') || e.target.classList.contains('upload-text')) {
                fileInput.click();
            }
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        cameraInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        // ============================================
        // üóúÔ∏è IMAGE COMPRESSION UTILITIES
        // ============================================
        
        // Compress image with aggressive settings (70-80% reduction)
        function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.3) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate new dimensions
                        let { width, height } = img;
                        
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width = Math.round(width * ratio);
                            height = Math.round(height * ratio);
                        }
                        
                        // Create canvas and compress
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed JPEG
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // Log compression stats
                        const originalSize = e.target.result.length;
                        const compressedSize = compressedDataUrl.length;
                        const reduction = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                        console.log(`üóúÔ∏è Image compressed: ${(originalSize/1024).toFixed(1)}KB ‚Üí ${(compressedSize/1024).toFixed(1)}KB (${reduction}% reduction)`);
                        
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Compress signature with very aggressive settings
        function compressSignature(canvas, maxWidth = 400, quality = 0.2) {
            return new Promise((resolve) => {
                const originalDataUrl = canvas.toDataURL('image/png');
                
                // Calculate new dimensions maintaining aspect ratio
                let width = canvas.width;
                let height = canvas.height;
                
                if (width > maxWidth) {
                    const ratio = maxWidth / width;
                    width = maxWidth;
                    height = Math.round(height * ratio);
                }
                
                // Create compressed canvas
                const compressCanvas = document.createElement('canvas');
                compressCanvas.width = width;
                compressCanvas.height = height;
                
                const ctx = compressCanvas.getContext('2d');
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(canvas, 0, 0, width, height);
                
                // Convert to compressed JPEG
                const compressedDataUrl = compressCanvas.toDataURL('image/jpeg', quality);
                
                // Log compression stats
                const originalSize = originalDataUrl.length;
                const compressedSize = compressedDataUrl.length;
                const reduction = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                console.log(`üóúÔ∏è Signature compressed: ${(originalSize/1024).toFixed(1)}KB ‚Üí ${(compressedSize/1024).toFixed(1)}KB (${reduction}% reduction)`);
                
                resolve(compressedDataUrl);
            });
        }

        // Store compressed images instead of raw files
        window.compressedImages = [];

        function handleFiles(files) {
            files.forEach(async (file) => {
                if (file.type.startsWith('image/')) {
                    const fileIndex = window.uploadedFiles.length;
                    window.uploadedFiles.push(file);
                    
                    try {
                        // Compress the image
                        const compressedDataUrl = await compressImage(file, 800, 800, 0.3);
                        window.compressedImages[fileIndex] = compressedDataUrl;
                        
                        // Show compressed preview
                        const preview = document.createElement('div');
                        preview.className = 'preview-image';
                        preview.setAttribute('data-index', fileIndex);
                        preview.innerHTML = `
                            <img src="${compressedDataUrl}" alt="Preview">
                            <button type="button" onclick="removeImage(${fileIndex})" style="z-index: 10;">√ó</button>
                        `;
                        previewImages.appendChild(preview);
                    } catch (error) {
                        console.error('Error compressing image:', error);
                        // Fallback to original
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            window.compressedImages[fileIndex] = e.target.result;
                            const preview = document.createElement('div');
                            preview.className = 'preview-image';
                            preview.setAttribute('data-index', fileIndex);
                            preview.innerHTML = `
                                <img src="${e.target.result}" alt="Preview">
                                <button type="button" onclick="removeImage(${fileIndex})" style="z-index: 10;">√ó</button>
                            `;
                            previewImages.appendChild(preview);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        }

        // Signature Pad
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let signatureStrokes = [];
        let currentStroke = [];

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            }
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const coords = getCoordinates(e);
            lastX = coords.x;
            lastY = coords.y;
            currentStroke = [{x: lastX, y: lastY}];
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const coords = getCoordinates(e);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
            
            currentStroke.push({x: coords.x, y: coords.y});
            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing() {
            if (isDrawing && currentStroke.length > 0) {
                signatureStrokes.push([...currentStroke]);
                currentStroke = [];
            }
            isDrawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        document.getElementById('clearSignature').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureStrokes = [];
        });

        document.getElementById('undoSignature').addEventListener('click', () => {
            if (signatureStrokes.length > 0) {
                signatureStrokes.pop();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                signatureStrokes.forEach(stroke => {
                    ctx.beginPath();
                    ctx.moveTo(stroke[0].x, stroke[0].y);
                    stroke.forEach(point => {
                        ctx.lineTo(point.x, point.y);
                    });
                    ctx.stroke();
                });
            }
        });

        // Form Submission
        const mainForm = document.getElementById('mainForm');
        const submissionsList = document.getElementById('submissionsList');
        window.submissions = []; // Make submissions globally accessible
        window.submissionIds = []; // Store Firebase document IDs

        // Load submissions from Firebase
        async function loadSubmissionsFromFirebase() {
            try {
                console.log('üì• Loading submissions from Firebase...');
                const snapshot = await db.collection('submissions').orderBy('createdAt', 'desc').get();
                window.submissions = [];
                window.submissionIds = [];
                
                snapshot.forEach(doc => {
                    window.submissions.push(doc.data());
                    window.submissionIds.push(doc.id);
                });
                
                console.log('‚úÖ Loaded', window.submissions.length, 'submissions from Firebase');
                updateSubmissionsList();
            } catch (error) {
                console.error('‚ùå Error loading submissions:', error);
            }
        }

        // Save submission to Firebase
        async function saveSubmissionToFirebase(submissionData) {
            try {
                const docRef = await db.collection('submissions').add({
                    ...submissionData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Submission saved with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Error saving submission:', error);
                throw error;
            }
        }

        // Update submission in Firebase
        async function updateSubmissionInFirebase(docId, submissionData) {
            try {
                await db.collection('submissions').doc(docId).update({
                    ...submissionData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Submission updated:', docId);
            } catch (error) {
                console.error('‚ùå Error updating submission:', error);
                throw error;
            }
        }

        // Delete submission from Firebase
        async function deleteSubmissionFromFirebase(docId) {
            try {
                await db.collection('submissions').doc(docId).delete();
                console.log('‚úÖ Submission deleted:', docId);
            } catch (error) {
                console.error('‚ùå Error deleting submission:', error);
                throw error;
            }
        }

        mainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const hour = document.getElementById('hour').value;
            const minute = document.getElementById('minute').value;
            const period = document.querySelector('.time-btn.active').dataset.period;
            
            // Get compressed signature image
            let signatureImage = null;
            if (signatureStrokes.length > 0) {
                signatureImage = await compressSignature(canvas, 400, 0.2);
            }
            
            // Get compressed attachment images
            const attachmentImages = window.compressedImages.filter(img => img !== undefined && img !== null);
            
            const formData = {
                submittedBy: currentUser.username,
                date: document.getElementById('formDate').value,
                time: `${hour}:${minute} ${period}`,
                customer: document.getElementById('customer').value,
                address: document.getElementById('address').value,
                order: document.getElementById('order').value,
                amount: document.getElementById('amount').value,
                rego: document.getElementById('rego').value,
                attachments: attachmentImages.length,
                attachmentImages: attachmentImages, // Store compressed images
                signature: signatureStrokes.length > 0,
                signatureImage: signatureImage,
                timestamp: new Date().toLocaleString()
            };
            
            try {
                // Check if we're editing an existing submission
                if (window.editingSubmissionIndex !== undefined) {
                    const docId = window.submissionIds[window.editingSubmissionIndex];
                    await updateSubmissionInFirebase(docId, formData);
                    
                    window.submissions[window.editingSubmissionIndex] = formData;
                    alert('Submission updated successfully!');
                    delete window.editingSubmissionIndex;
                    
                    // Reset submit button
                    const submitBtn = document.querySelector('#mainForm .submit-button');
                    submitBtn.textContent = 'Submit';
                    submitBtn.style.background = 'linear-gradient(135deg, var(--accent) 0%, #d63447 100%)';
                    
                    // Switch to submissions tab if admin
                    if (currentUser.role === 'admin') {
                        document.querySelector('[data-tab="submissions"]').click();
                    }
                } else {
                    // Save new submission to Firebase
                    const docId = await saveSubmissionToFirebase(formData);
                    window.submissions.unshift(formData);
                    window.submissionIds.unshift(docId);
                    
                    alert('Form submitted successfully!');
                }
                
                updateSubmissionsList();
                
                mainForm.reset();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                signatureStrokes = [];
                window.uploadedFiles = [];
                window.compressedImages = []; // Reset compressed images
                previewImages.innerHTML = '';
                
                // Set default date and time again
                const now = new Date();
                const todayDate = now.toISOString().split('T')[0];
                document.getElementById('formDate').value = todayDate;
                
                let hours = now.getHours();
                const minutes = now.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                
                document.getElementById('hour').value = hours;
                document.getElementById('minute').value = minutes.toString().padStart(2, '0');
                
                document.querySelectorAll('.time-btn').forEach(btn => {
                    if (btn.dataset.period === ampm) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                alert('Error saving submission: ' + error.message);
            }
        });

        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('formDate').value = today;
        
        // Initialize customer management button
        const addCustomerBtn = document.getElementById('addCustomerBtn');
        if (addCustomerBtn) {
            addCustomerBtn.addEventListener('click', function() {
                openCustomerModal();
            });
        }
        
        // Initialize item management button
        const addItemBtn = document.getElementById('addItemBtn');
        if (addItemBtn) {
            addItemBtn.addEventListener('click', function() {
                openItemModal();
            });
        }
        
        // Initialize Create Docket button
        const createDocketBtn = document.getElementById('createDocketBtn');
        if (createDocketBtn) {
            createDocketBtn.addEventListener('click', function() {
                if (window.submissions.length === 0) {
                    alert('No submissions available. Please submit some forms first.');
                    return;
                }
                openDocketModal();
            });
        }
        
        // Initialize Create New Customer button from form
        const createCustomerFromForm = document.getElementById('createCustomerFromForm');
        if (createCustomerFromForm) {
            createCustomerFromForm.addEventListener('click', function() {
                console.log('Create customer from form clicked');
                window.openedFromForm = true;
                openCustomerModal();
            });
        }
        
        // Populate customer dropdown on load
        populateCustomerDropdown();
        
        // Populate item dropdown on load
        populateItemDropdown();
        
        // Add customer selection change listener
        const customerInput = document.getElementById('customer');
        if (customerInput) {
            customerInput.addEventListener('input', function() {
                const customerName = this.value;
                const customerInfo = document.getElementById('customerInfo');
                
                // Find matching customer
                const customer = window.customers.find(c => c.name === customerName);
                
                if (customer) {
                    document.getElementById('customerInfoEmail').textContent = customer.email;
                    document.getElementById('customerInfoPhone').textContent = customer.phone;
                    document.getElementById('customerInfoAddress').textContent = customer.address;
                    customerInfo.style.display = 'block';
                } else {
                    customerInfo.style.display = 'none';
                }
            });
            
            // Also check on blur (when user clicks away)
            customerInput.addEventListener('blur', function() {
                const customerName = this.value;
                const customer = window.customers.find(c => c.name === customerName);
                
                if (customer) {
                    const customerInfo = document.getElementById('customerInfo');
                    document.getElementById('customerInfoEmail').textContent = customer.email;
                    document.getElementById('customerInfoPhone').textContent = customer.phone;
                    document.getElementById('customerInfoAddress').textContent = customer.address;
                    customerInfo.style.display = 'block';
                }
            });
        }
        
        // üî• LOAD ALL DATA FROM FIREBASE
        console.log('üî• Loading data from Firebase...');
        loadCustomersFromFirebase();
        loadItemsFromFirebase();
        loadSubmissionsFromFirebase();
        
        console.log('Initialization complete!');
        }); // End of DOMContentLoaded

        // Global functions for submission management (accessible from inline onclick)
        function updateSubmissionsList() {
            const submissionsList = document.getElementById('submissionsList');
            if (window.submissions.length === 0) {
                submissionsList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No submissions yet.</p>';
                return;
            }
            
            submissionsList.innerHTML = window.submissions.map((sub, index) => `
                <div class="field-item" style="margin-bottom: 1rem;">
                    <div class="field-info">
                        <h4>Submission #${index + 1} - ${sub.customer}</h4>
                        <p>Date: ${sub.date} ${sub.time} | Order: ${sub.order} | Amount: ${sub.amount}</p>
                        <p style="font-size: 0.8rem; margin-top: 0.3rem;">Submitted by: ${sub.submittedBy} | ${sub.timestamp}</p>
                    </div>
                    <div class="field-actions">
                        <button onclick="viewSubmission(${index})">View</button>
                        <button onclick="editSubmission(${index})" style="background: #667eea; color: white; border-color: #667eea;">Edit</button>
                        <button onclick="deleteSubmission(${index})" style="background: #dc3545; color: white; border-color: #dc3545;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function viewSubmission(index) {
            const sub = window.submissions[index];
            const modal = document.createElement('div');
            modal.className = 'submission-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
                <div class="modal-box">
                    <div class="modal-header">
                        <h3>Submission #${index + 1}</h3>
                        <button class="close-btn" onclick="this.closest('.submission-modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-row">
                            <strong>Submitted By:</strong>
                            <span>${sub.submittedBy}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Date:</strong>
                            <span>${sub.date}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Time:</strong>
                            <span>${sub.time}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Customer:</strong>
                            <span>${sub.customer}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Address:</strong>
                            <span>${sub.address}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Order Type:</strong>
                            <span>${sub.order}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Amount:</strong>
                            <span>${sub.amount}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Rego:</strong>
                            <span>${sub.rego}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Attachments:</strong>
                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span style="background: ${sub.attachments > 0 ? 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' : '#6c757d'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${sub.attachments} file(s)</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <strong>Signature:</strong>
                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span style="background: ${sub.signature ? 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' : 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${sub.signature ? '‚úì Signed' : '‚úó Not Signed'}</span>
                            </span>
                        </div>
                        ${sub.signatureImage ? `
                        <div style="margin-top: 1.5rem; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); border: 2px solid #dee2e6;">
                            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 0.75rem 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -50%; right: -10%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                                <h4 style="color: white; margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; position: relative; z-index: 1;">üìù Signature</h4>
                            </div>
                            <div style="padding: 1rem; background: #f8f9fa; text-align: center;">
                                <img src="${sub.signatureImage}" alt="Signature" style="max-width: 100%; max-height: 120px; border: 1px solid #dee2e6; border-radius: 4px; background: white; display: inline-block;">
                            </div>
                        </div>
                        ` : ''}
                        ${sub.attachmentImages && sub.attachmentImages.length > 0 ? `
                        <div style="margin-top: 1.5rem; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); border: 2px solid #dee2e6;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0.75rem 1rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -50%; right: -10%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                                <h4 style="color: white; margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; position: relative; z-index: 1;">üìé Attachments (${sub.attachmentImages.length})</h4>
                            </div>
                            <div style="padding: 1rem; background: #f8f9fa; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem;">
                                ${sub.attachmentImages.map((img, i) => `
                                    <div style="border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; background: white;">
                                        <img src="${img}" alt="Attachment ${i + 1}" style="width: 100%; height: 100px; object-fit: cover; cursor: pointer;" onclick="window.open('${img}', '_blank')">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <div class="detail-row">
                            <strong>Submitted:</strong>
                            <span>${sub.timestamp}</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-edit" onclick="editSubmission(${index}); this.closest('.submission-modal').remove();">Edit</button>
                        <button class="btn-close" onclick="this.closest('.submission-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function editSubmission(index) {
            const sub = window.submissions[index];
            
            // Switch to form tab
            document.querySelector('[data-tab="form"]').click();
            
            // Populate form with submission data
            document.getElementById('formDate').value = sub.date;
            
            // Parse time
            const timeParts = sub.time.split(' ');
            const hourMin = timeParts[0].split(':');
            document.getElementById('hour').value = hourMin[0];
            document.getElementById('minute').value = hourMin[1];
            
            // Set AM/PM
            document.querySelectorAll('.time-btn').forEach(btn => {
                if (btn.dataset.period === timeParts[1]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            document.getElementById('customer').value = sub.customer;
            document.getElementById('address').value = sub.address;
            document.getElementById('order').value = sub.order;
            document.getElementById('amount').value = sub.amount;
            document.getElementById('rego').value = sub.rego;
            
            // Restore signature if exists
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (sub.signatureImage) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = sub.signatureImage;
            }
            
            // Store the index being edited
            window.editingSubmissionIndex = index;
            
            // Change submit button text
            const submitBtn = document.querySelector('#mainForm .submit-button');
            submitBtn.textContent = 'Update Submission';
            submitBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            alert('Form loaded with submission data. Make your changes and click "Update Submission".');
        }

        function deleteSubmission(index) {
            if (confirm('Are you sure you want to delete this submission?')) {
                const docId = window.submissionIds[index];
                deleteSubmissionFromFirebase(docId).then(() => {
                    window.submissions.splice(index, 1);
                    window.submissionIds.splice(index, 1);
                    updateSubmissionsList();
                    alert('Submission deleted successfully!');
                }).catch(error => {
                    alert('Error deleting submission: ' + error.message);
                });
            }
        }

        // Image removal function (global scope)
        function removeImage(index) {
            console.log('Removing image at index:', index);
            console.log('Current files:', window.uploadedFiles.length);
            
            // Remove the file and compressed image from arrays
            window.uploadedFiles.splice(index, 1);
            window.compressedImages.splice(index, 1);
            
            console.log('Files after removal:', window.uploadedFiles.length);
            
            // Clear and rebuild preview
            const previewImages = document.getElementById('previewImages');
            previewImages.innerHTML = '';
            
            // Rebuild all previews with correct indices using compressed images
            window.compressedImages.forEach((compressedImg, newIndex) => {
                if (compressedImg) {
                    const preview = document.createElement('div');
                    preview.className = 'preview-image';
                    preview.setAttribute('data-index', newIndex);
                    preview.innerHTML = `
                        <img src="${compressedImg}" alt="Preview">
                        <button type="button" onclick="removeImage(${newIndex})" style="z-index: 10;">√ó</button>
                    `;
                    previewImages.appendChild(preview);
                }
            });
            
            console.log('Preview rebuilt');
        }

        // Customer Management Functions
        window.customers = []; // Global customers array
        window.editingCustomerIndex = null;
        window.customerIds = []; // Store Firebase document IDs

        // Load customers from Firebase
        async function loadCustomersFromFirebase() {
            try {
                console.log('üì• Loading customers from Firebase...');
                const snapshot = await db.collection('customers').orderBy('createdAt', 'desc').get();
                window.customers = [];
                window.customerIds = [];
                
                snapshot.forEach(doc => {
                    window.customers.push(doc.data());
                    window.customerIds.push(doc.id);
                });
                
                console.log('‚úÖ Loaded', window.customers.length, 'customers from Firebase');
                updateCustomersList();
                populateCustomerDropdown();
            } catch (error) {
                console.error('‚ùå Error loading customers:', error);
            }
        }

        // Save customer to Firebase
        async function saveCustomerToFirebase(customerData) {
            try {
                const docRef = await db.collection('customers').add({
                    ...customerData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Customer saved with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Error saving customer:', error);
                throw error;
            }
        }

        // Update customer in Firebase
        async function updateCustomerInFirebase(docId, customerData) {
            try {
                await db.collection('customers').doc(docId).update({
                    ...customerData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Customer updated:', docId);
            } catch (error) {
                console.error('‚ùå Error updating customer:', error);
                throw error;
            }
        }

        // Delete customer from Firebase
        async function deleteCustomerFromFirebase(docId) {
            try {
                await db.collection('customers').doc(docId).delete();
                console.log('‚úÖ Customer deleted:', docId);
            } catch (error) {
                console.error('‚ùå Error deleting customer:', error);
                throw error;
            }
        }

        // Populate customer dropdown
        function populateCustomerDropdown() {
            const customerList = document.getElementById('customerList');
            if (!customerList) return;
            
            // Clear existing options
            customerList.innerHTML = '';
            
            // Add customer options
            window.customers.forEach((customer, index) => {
                const option = document.createElement('option');
                option.value = customer.name;
                option.setAttribute('data-email', customer.email);
                option.setAttribute('data-phone', customer.phone);
                option.setAttribute('data-address', customer.address);
                option.setAttribute('data-index', index);
                option.textContent = `${customer.name} - ${customer.email}`;
                customerList.appendChild(option);
            });
            
            console.log('Customer datalist populated with', window.customers.length, 'customers');
        }

        function openCustomerModal(customerIndex = null) {
            console.log('Opening customer modal, index:', customerIndex);
            const modal = document.getElementById('customerModal');
            const modalTitle = document.getElementById('customerModalTitle');
            
            console.log('Modal element:', modal);
            console.log('Modal title element:', modalTitle);
            
            if (customerIndex !== null) {
                // Edit mode
                window.editingCustomerIndex = customerIndex;
                const customer = window.customers[customerIndex];
                modalTitle.textContent = 'Edit Customer';
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerAddress').value = customer.address;
            } else {
                // Add mode
                window.editingCustomerIndex = null;
                modalTitle.textContent = 'Add New Customer';
                document.getElementById('customerForm').reset();
            }
            
            modal.style.display = 'flex';
            console.log('Modal should be visible now');
        }

        function closeCustomerModal() {
            const modal = document.getElementById('customerModal');
            modal.style.display = 'none';
            window.editingCustomerIndex = null;
            document.getElementById('customerForm').reset();
        }

        async function saveCustomer() {
            console.log('Saving customer...');
            const form = document.getElementById('customerForm');
            
            // Validate form
            if (!form.checkValidity()) {
                console.log('Form validation failed');
                form.reportValidity();
                return;
            }
            
            console.log('Form is valid, collecting data...');
            
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                createdAt: new Date().toLocaleString()
            };
            
            console.log('Customer data:', customerData);
            
            try {
                if (window.editingCustomerIndex !== null) {
                    // Update existing customer in Firebase
                    const docId = window.customerIds[window.editingCustomerIndex];
                    await updateCustomerInFirebase(docId, customerData);
                    
                    window.customers[window.editingCustomerIndex] = {
                        ...window.customers[window.editingCustomerIndex],
                        ...customerData,
                        updatedAt: new Date().toLocaleString()
                    };
                    console.log('Customer updated');
                    alert('Customer updated successfully!');
                } else {
                    // Add new customer to Firebase
                    const docId = await saveCustomerToFirebase(customerData);
                    window.customers.unshift(customerData);
                    window.customerIds.unshift(docId);
                    
                    console.log('New customer added. Total customers:', window.customers.length);
                    alert('Customer added successfully!');
                    
                    // If opened from form, select the new customer and go back to form tab
                    if (window.openedFromForm) {
                        populateCustomerDropdown();
                        const customerInput = document.getElementById('customer');
                        if (customerInput) {
                            customerInput.value = customerData.name;
                            // Trigger input event to show customer info
                            customerInput.dispatchEvent(new Event('input'));
                        }
                        document.querySelector('[data-tab="form"]').click();
                        window.openedFromForm = false;
                    }
                }
                
                updateCustomersList();
                populateCustomerDropdown();
                closeCustomerModal();
            } catch (error) {
                alert('Error saving customer: ' + error.message);
            }
        }

        function updateCustomersList() {
            const customersList = document.getElementById('customersList');
            
            if (window.customers.length === 0) {
                customersList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No customers yet. Click "Add New Customer" to get started.</p>';
                return;
            }
            
            customersList.innerHTML = window.customers.map((customer, index) => `
                <div class="field-item" style="margin-bottom: 1rem;">
                    <div class="field-info">
                        <h4>${customer.name}</h4>
                        <p><strong>Email:</strong> ${customer.email} | <strong>Phone:</strong> ${customer.phone}</p>
                        <p style="font-size: 0.85rem; margin-top: 0.3rem;"><strong>Address:</strong> ${customer.address}</p>
                        <p style="font-size: 0.8rem; color: var(--gray); margin-top: 0.3rem;">Added: ${customer.createdAt}</p>
                    </div>
                    <div class="field-actions">
                        <button onclick="viewCustomer(${index})">View</button>
                        <button onclick="openCustomerModal(${index})" style="background: #667eea; color: white; border-color: #667eea;">Edit</button>
                        <button onclick="deleteCustomer(${index})" style="background: #dc3545; color: white; border-color: #dc3545;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function viewCustomer(index) {
            const customer = window.customers[index];
            const modal = document.createElement('div');
            modal.className = 'submission-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
                <div class="modal-box">
                    <div class="modal-header">
                        <h3>Customer Details</h3>
                        <button class="close-btn" onclick="this.closest('.submission-modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-row">
                            <strong>Customer Name:</strong>
                            <span>${customer.name}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Email:</strong>
                            <span>${customer.email}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Phone:</strong>
                            <span>${customer.phone}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Address:</strong>
                            <span>${customer.address}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Added:</strong>
                            <span>${customer.createdAt}</span>
                        </div>
                        ${customer.updatedAt ? `
                        <div class="detail-row">
                            <strong>Last Updated:</strong>
                            <span>${customer.updatedAt}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn-edit" onclick="openCustomerModal(${index}); this.closest('.submission-modal').remove();">Edit</button>
                        <button class="btn-close" onclick="this.closest('.submission-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function deleteCustomer(index) {
            if (confirm('Are you sure you want to delete this customer?')) {
                try {
                    const docId = window.customerIds[index];
                    await deleteCustomerFromFirebase(docId);
                    
                    window.customers.splice(index, 1);
                    window.customerIds.splice(index, 1);
                    
                    updateCustomersList();
                    populateCustomerDropdown();
                    alert('Customer deleted successfully!');
                } catch (error) {
                    alert('Error deleting customer: ' + error.message);
                }
            }
        }

        // Item Management Functions
        window.items = []; // Global items array
        window.editingItemIndex = null;
        window.itemIds = []; // Store Firebase document IDs

        // Load items from Firebase
        async function loadItemsFromFirebase() {
            try {
                console.log('üì• Loading items from Firebase...');
                const snapshot = await db.collection('items').orderBy('createdAt', 'desc').get();
                window.items = [];
                window.itemIds = [];
                
                snapshot.forEach(doc => {
                    window.items.push(doc.data());
                    window.itemIds.push(doc.id);
                });
                
                console.log('‚úÖ Loaded', window.items.length, 'items from Firebase');
                updateItemsList();
                populateItemDropdown();
            } catch (error) {
                console.error('‚ùå Error loading items:', error);
            }
        }

        // Save item to Firebase
        async function saveItemToFirebase(itemData) {
            try {
                const docRef = await db.collection('items').add({
                    ...itemData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Item saved with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Error saving item:', error);
                throw error;
            }
        }

        // Update item in Firebase
        async function updateItemInFirebase(docId, itemData) {
            try {
                await db.collection('items').doc(docId).update({
                    ...itemData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Item updated:', docId);
            } catch (error) {
                console.error('‚ùå Error updating item:', error);
                throw error;
            }
        }

        // Delete item from Firebase
        async function deleteItemFromFirebase(docId) {
            try {
                await db.collection('items').doc(docId).delete();
                console.log('‚úÖ Item deleted:', docId);
            } catch (error) {
                console.error('‚ùå Error deleting item:', error);
                throw error;
            }
        }

        // Populate item dropdown (order field)
        function populateItemDropdown() {
            const orderList = document.getElementById('orderList');
            if (!orderList) return;
            
            // Clear all existing options
            orderList.innerHTML = '';
            
            // Add only item options
            window.items.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = item.name;
                option.setAttribute('data-price', item.price);
                option.setAttribute('data-index', index);
                orderList.appendChild(option);
            });
            
            console.log('Item dropdown populated with', window.items.length, 'items');
        }

        function openItemModal(itemIndex = null) {
            console.log('Opening item modal, index:', itemIndex);
            const modal = document.getElementById('itemModal');
            const modalTitle = document.getElementById('itemModalTitle');
            
            if (itemIndex !== null) {
                // Edit mode
                window.editingItemIndex = itemIndex;
                const item = window.items[itemIndex];
                modalTitle.textContent = 'Edit Item';
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemPrice').value = item.price;
            } else {
                // Add mode
                window.editingItemIndex = null;
                modalTitle.textContent = 'Add New Item';
                document.getElementById('itemForm').reset();
            }
            
            modal.style.display = 'flex';
            console.log('Item modal should be visible now');
        }

        function closeItemModal() {
            const modal = document.getElementById('itemModal');
            modal.style.display = 'none';
            window.editingItemIndex = null;
            document.getElementById('itemForm').reset();
        }

        async function saveItem() {
            console.log('Saving item...');
            const form = document.getElementById('itemForm');
            
            // Validate form
            if (!form.checkValidity()) {
                console.log('Form validation failed');
                form.reportValidity();
                return;
            }
            
            console.log('Form is valid, collecting data...');
            
            const itemData = {
                name: document.getElementById('itemName').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                createdAt: new Date().toLocaleString()
            };
            
            console.log('Item data:', itemData);
            
            try {
                if (window.editingItemIndex !== null) {
                    // Update existing item in Firebase
                    const docId = window.itemIds[window.editingItemIndex];
                    await updateItemInFirebase(docId, itemData);
                    
                    window.items[window.editingItemIndex] = {
                        ...window.items[window.editingItemIndex],
                        ...itemData,
                        updatedAt: new Date().toLocaleString()
                    };
                    console.log('Item updated');
                    alert('Item updated successfully!');
                } else {
                    // Add new item to Firebase
                    const docId = await saveItemToFirebase(itemData);
                    window.items.unshift(itemData);
                    window.itemIds.unshift(docId);
                    
                    console.log('New item added. Total items:', window.items.length);
                    alert('Item added successfully!');
                }
                
                updateItemsList();
                populateItemDropdown();
                closeItemModal();
            } catch (error) {
                alert('Error saving item: ' + error.message);
            }
        }

        function updateItemsList() {
            const itemsList = document.getElementById('itemsList');
            
            if (window.items.length === 0) {
                itemsList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No items yet. Click "Add New Item" to get started.</p>';
                return;
            }
            
            itemsList.innerHTML = window.items.map((item, index) => `
                <div class="field-item" style="margin-bottom: 1rem;">
                    <div class="field-info">
                        <h4>${item.name}</h4>
                        <p><strong>Price:</strong> $${item.price.toFixed(2)}</p>
                        <p style="font-size: 0.8rem; color: var(--gray); margin-top: 0.3rem;">Added: ${item.createdAt}</p>
                    </div>
                    <div class="field-actions">
                        <button onclick="viewItem(${index})">View</button>
                        <button onclick="openItemModal(${index})" style="background: #667eea; color: white; border-color: #667eea;">Edit</button>
                        <button onclick="deleteItem(${index})" style="background: #dc3545; color: white; border-color: #dc3545;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function viewItem(index) {
            const item = window.items[index];
            const modal = document.createElement('div');
            modal.className = 'submission-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
                <div class="modal-box">
                    <div class="modal-header">
                        <h3>Item Details</h3>
                        <button class="close-btn" onclick="this.closest('.submission-modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-row">
                            <strong>Item Name:</strong>
                            <span>${item.name}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Price:</strong>
                            <span>$${item.price.toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Added:</strong>
                            <span>${item.createdAt}</span>
                        </div>
                        ${item.updatedAt ? `
                        <div class="detail-row">
                            <strong>Last Updated:</strong>
                            <span>${item.updatedAt}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn-edit" onclick="openItemModal(${index}); this.closest('.submission-modal').remove();">Edit</button>
                        <button class="btn-close" onclick="this.closest('.submission-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    const docId = window.itemIds[index];
                    await deleteItemFromFirebase(docId);
                    
                    window.items.splice(index, 1);
                    window.itemIds.splice(index, 1);
                    
                    updateItemsList();
                    populateItemDropdown();
                    alert('Item deleted successfully!');
                } catch (error) {
                    alert('Error deleting item: ' + error.message);
                }
            }
        }

        // Docket Management Functions
        window.docketCounter = 0; // Track docket numbers
        
        function openDocketModal() {
            const modal = document.getElementById('docketModal');
            const customerSelect = document.getElementById('docketCustomer');
            
            // Populate customer dropdown
            customerSelect.innerHTML = '<option value="">Select a customer</option>';
            
            // Get unique customers from submissions
            const uniqueCustomers = [...new Set(window.submissions.map(s => s.customer))];
            uniqueCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerSelect.appendChild(option);
            });
            
            // Set default dates (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('docketEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('docketStartDate').value = startDate.toISOString().split('T')[0];
            
            // Hide preview
            document.getElementById('docketPreview').style.display = 'none';
            
            modal.style.display = 'flex';
        }

        function closeDocketModal() {
            const modal = document.getElementById('docketModal');
            modal.style.display = 'none';
            document.getElementById('docketForm').reset();
            document.getElementById('docketPreview').style.display = 'none';
        }

        function previewDocket() {
            const form = document.getElementById('docketForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const customer = document.getElementById('docketCustomer').value;
            const startDate = document.getElementById('docketStartDate').value;
            const endDate = document.getElementById('docketEndDate').value;
            
            // Filter submissions
            const filteredSubmissions = window.submissions.filter(sub => {
                const subDate = new Date(sub.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                return sub.customer === customer && subDate >= start && subDate <= end;
            });
            
            // Show preview
            const preview = document.getElementById('docketPreview');
            const previewText = document.getElementById('docketPreviewText');
            
            if (filteredSubmissions.length === 0) {
                previewText.textContent = 'No submissions found for this customer in the selected date range.';
                previewText.style.color = '#dc3545';
            } else {
                previewText.textContent = `Found ${filteredSubmissions.length} submission(s) for ${customer} between ${startDate} and ${endDate}.`;
                previewText.style.color = '#28a745';
            }
            
            preview.style.display = 'block';
        }

        function generateDocket() {
            const form = document.getElementById('docketForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const customer = document.getElementById('docketCustomer').value;
            const startDate = document.getElementById('docketStartDate').value;
            const endDate = document.getElementById('docketEndDate').value;
            
            // Filter submissions
            const filteredSubmissions = window.submissions.filter(sub => {
                const subDate = new Date(sub.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                return sub.customer === customer && subDate >= start && subDate <= end;
            });
            
            if (filteredSubmissions.length === 0) {
                alert('No submissions found for this customer in the selected date range.');
                return;
            }
            
            // Generate docket HTML
            const docketContent = generateDocketHTML(customer, startDate, endDate, filteredSubmissions);
            
            // Show docket view modal
            document.getElementById('docketViewContent').innerHTML = docketContent;
            document.getElementById('docketViewModal').style.display = 'flex';
            closeDocketModal();
        }

        function generateDocketHTML(customer, startDate, endDate, submissions) {
            // Generate docket number
            window.docketCounter++;
            const docketNumber = `FGR-${String(window.docketCounter).padStart(3, '0')}`;
            
            // Calculate totals
            let totalAmount = 0;
            submissions.forEach(sub => {
                totalAmount += parseFloat(sub.amount) || 0;
            });
            
            // Get customer info
            const customerInfo = window.customers.find(c => c.name === customer);
            
            let html = `
                <div style="background: white; width: 210mm; min-height: 297mm; margin: 0 auto; position: relative;">
                    <!-- Header matching main page style -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 1.5rem 2rem; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -50%; right: -10%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 1; text-align: center;">
                            <h1 style="font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: white; letter-spacing: 2px; margin: 0;">FLOWRITE</h1>
                            <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase; font-weight: 300; margin: 0.3rem 0;">Concrete Recycling & Materials</p>
                            <div style="margin-top: 1rem; padding: 0.5rem 1rem; background: rgba(233, 69, 96, 0.2); border: 2px solid rgba(233, 69, 96, 0.5); border-radius: 8px; display: inline-block;">
                                <h2 style="color: #e94560; margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 1px;">DOCKET #${docketNumber}</h2>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content with A4 padding -->
                    <div style="padding: 1.5rem 2rem;">
                        <!-- Info Cards -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; border: 2px solid #dee2e6;">
                                <h3 style="color: #1a1a2e; margin: 0 0 0.75rem 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e94560; padding-bottom: 0.4rem;">Customer Information</h3>
                                <div style="line-height: 1.6; font-size: 0.9rem;">
                                    <p style="margin: 0.4rem 0;"><strong style="color: #1a1a2e;">Name:</strong> <span style="color: #6c757d;">${customer}</span></p>
                                    ${customerInfo ? `
                                        <p style="margin: 0.4rem 0;"><strong style="color: #1a1a2e;">Email:</strong> <span style="color: #6c757d;">${customerInfo.email}</span></p>
                                        <p style="margin: 0.4rem 0;"><strong style="color: #1a1a2e;">Phone:</strong> <span style="color: #6c757d;">${customerInfo.phone}</span></p>
                                        <p style="margin: 0.4rem 0;"><strong style="color: #1a1a2e;">Address:</strong> <span style="color: #6c757d;">${customerInfo.address}</span></p>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; border: 2px solid #dee2e6;">
                                <h3 style="color: #1a1a2e; margin: 0 0 0.75rem 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e94560; padding-bottom: 0.4rem;">Period</h3>
                                <div style="line-height: 1.6; font-size: 0.9rem;">
                                    <p style="margin: 0.4rem 0;"><strong style="color: #1a1a2e;">Start Date:</strong> <span style="color: #6c757d;">${new Date(startDate).toLocaleDateString()}</span></p>
                                    <p style="margin: 0.4rem 0;"><strong style="color: #1a1a2e;">End Date:</strong> <span style="color: #6c757d;">${new Date(endDate).toLocaleDateString()}</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Table -->
                        <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); border: 2px solid #dee2e6;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white;">
                                        <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem;">#</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem;">Date</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem;">Time</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem;">Address</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem;">Order</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: right; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem;">Amount</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem;">Rego</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.75rem; width: 100px;">Signature</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            submissions.forEach((sub, index) => {
                const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                html += `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 0.6rem 0.5rem; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #1a1a2e;">${index + 1}</td>
                        <td style="padding: 0.6rem 0.5rem; border-bottom: 1px solid #dee2e6; color: #6c757d;">${sub.date}</td>
                        <td style="padding: 0.6rem 0.5rem; border-bottom: 1px solid #dee2e6; color: #6c757d;">${sub.time}</td>
                        <td style="padding: 0.6rem 0.5rem; border-bottom: 1px solid #dee2e6; color: #6c757d;">${sub.address}</td>
                        <td style="padding: 0.6rem 0.5rem; border-bottom: 1px solid #dee2e6; color: #6c757d;">${sub.order}</td>
                        <td style="padding: 0.6rem 0.5rem; text-align: right; border-bottom: 1px solid #dee2e6; color: #1a1a2e; font-weight: 600;">${sub.amount}</td>
                        <td style="padding: 0.6rem 0.5rem; border-bottom: 1px solid #dee2e6; color: #6c757d;">${sub.rego}</td>
                        <td style="padding: 0.4rem; border-bottom: 1px solid #dee2e6; text-align: center;">
                            ${sub.signatureImage ? `<img src="${sub.signatureImage}" alt="Signature" style="max-width: 80px; max-height: 40px; display: block; margin: 0 auto; border: 1px solid #dee2e6; border-radius: 3px; background: white;">` : '<span style="color: #999; font-size: 0.75rem;">No signature</span>'}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                                <tfoot>
                                    <tr style="background: linear-gradient(135deg, #e94560 0%, #d63447 100%); color: white;">
                                        <td colspan="5" style="padding: 0.9rem 0.5rem; text-align: right; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.95rem;">TOTAL AMOUNT:</td>
                                        <td style="padding: 0.9rem 0.5rem; text-align: right; font-weight: 700; font-size: 1.1rem;">${totalAmount.toFixed(1)}</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Footer -->
                        <div style="margin-top: 1.5rem; text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                            <p style="color: #6c757d; font-size: 0.85rem; margin: 0; font-weight: 500;">Flowrite - Concrete Recycling & Materials</p>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function closeDocketViewModal() {
            document.getElementById('docketViewModal').style.display = 'none';
        }

        function printDocket() {
            const docketContent = document.getElementById('docketViewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Docket - Flowrite</title>
                    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Archivo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Archivo', sans-serif; margin: 0; padding: 20px; }
                        @media print {
                            body { margin: 0; }
                            @page { margin: 1cm; }
                        }
                    </style>
                </head>
                <body>
                    ${docketContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
    </script>
</body>
</html>